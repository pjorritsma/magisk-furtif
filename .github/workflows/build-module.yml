name: Build MagiskFurtif Module

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - 'monitor_live.sh'
  release:
    types: [ created, edited ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: Verify directory structure
      run: |
        echo "Current directory contents:"
        ls -la
        
        echo "Base directory contents:"
        ls -la base/
        
        # Verify required files exist
        if [ ! -f "base/service.sh" ]; then
          echo "ERROR: base/service.sh not found!"
          exit 1
        fi
        
        if [ ! -f "base/install.sh" ]; then
          echo "ERROR: base/install.sh not found!"
          exit 1
        fi
        
        if [ ! -f "base/module.prop" ]; then
          echo "ERROR: base/module.prop not found!"
          exit 1
        fi
        
        echo "All required files found!"
        
    - name: Build Magisk Module
      id: build
      run: |
        # Build module with Python script
        python build.py
        
        # Find the created ZIP file
        ZIP_FILE=$(find builds -name "*.zip" | head -n 1)
        if [ -n "$ZIP_FILE" ]; then
          echo "Created ZIP file: $ZIP_FILE"
          echo "ZIP_FILE=$ZIP_FILE" >> $GITHUB_ENV
          
          # Extract version from filename (updated for new naming)
          VERSION=$(echo $ZIP_FILE | grep -oP 'MagiskFurtif-f3ger-\K[0-9.]+(?=\.zip)')
          echo "Extracted version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # Verify ZIP file exists and has content
          if [ -f "$ZIP_FILE" ]; then
            echo "ZIP file size: $(ls -lh $ZIP_FILE | awk '{print $5}')"
            echo "ZIP file contents:"
            unzip -l "$ZIP_FILE" | head -20
          else
            echo "ERROR: ZIP file not found after build!"
            exit 1
          fi
        else
          echo "ERROR: No ZIP file was created, build failed!"
          exit 1
        fi
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: MagiskFurtif-Module
        path: ${{ env.ZIP_FILE }}
        
    - name: Upload to Release
      if: github.event_name == 'release'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Upload asset using GitHub CLI
        gh release upload ${{ github.event.release.tag_name }} "${{ env.ZIP_FILE }}" --clobber
          
    - name: Update updater.json
      if: github.event_name == 'release'
      run: |
        # Checkout the main branch explicitly
        git checkout main
        
        VERSION="${{ env.VERSION }}"
        VERSION_CODE=$(echo $VERSION | sed 's/\.//g')
        
        # Create temporary JSON file with correct naming
        cat > updater.json.tmp << EOF
        {
            "version": "$VERSION",
            "versionCode": $VERSION_CODE,
            "zipUrl": "https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/MagiskFurtif-f3ger-$VERSION.zip"
        }
        EOF
        
        # Replace existing updater.json
        mv updater.json.tmp updater.json
        
        # Commit and push updated updater.json
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        git add updater.json
        git commit -m "Update updater.json to version $VERSION [skip ci]"
        git push origin main